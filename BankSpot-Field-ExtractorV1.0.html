<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BankSpot 欄位抽取器 V1.1（單檔版）</title>
  <!-- 讀取 Excel / CSV：使用 xlsx.js（支援 .xlsx/.xls/.csv） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #fff; --fg: #111; --muted: #666; --accent: #0b5cdb; --ok: #0a7b32; --chip: #eef3ff;
      --border:#c9d1e1; --panel:#f7f9fc; --z-modal: 999;
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#0b0d10; --fg:#e6e6e6; --muted:#9aa3ad; --chip:#142744; --border:#2b3442; --panel:#101827; }
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI",
      Roboto, "Noto Sans TC", "Microsoft JhengHei", Arial, "PingFang TC", sans-serif;
      background: var(--bg); color: var(--fg);
      display: grid; grid-template-rows: auto 1fr; gap: 12px;
    }
    header { padding: 16px 16px 0; }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .sub { color: var(--muted); font-size: 13px; }
    .bar { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 12px; }
    .btn, label.btn { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--chip); color: var(--fg); cursor: pointer; user-select:none; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    input[type="file"] { display: none; }
    .drop { margin: 12px 16px 0; padding: 18px; border: 2px dashed #aab7cf; border-radius: 12px; text-align: center; color: var(--muted); transition: .2s ease; }
    .drop.dragover { background: #f0f6ff; border-color: var(--accent); color: var(--fg); }

    main { min-height: 0; display: grid; grid-template-rows: auto 1fr; gap: 8px; padding: 0 16px 16px; }
    .meta { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 13px; color: var(--muted); }
    .chip { background: var(--chip); border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; color: var(--fg); }
    .tips { font-size: 12px; color: var(--muted); }

    .table-wrap { min-height: 0; overflow: auto; border: 1px solid #d7dee9; border-radius: 12px; }
    table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 14px; }
    thead th { position: sticky; top: 0; background: var(--panel); color: #3a4758; text-align: left; font-weight: 600; border-bottom: 1px solid #e3e9f3; padding: 10px; }
    tbody td { border-bottom: 1px solid #eef2f8; padding: 8px 10px; white-space: nowrap; }
    tbody tr:nth-child(2n) td { background: #fbfcff; }

    /* 表頭排序狀態 */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable::after { content: '↕'; font-size: 12px; margin-left: 6px; opacity: .45; }
    th.sortable.sort-asc::after { content: '▲'; opacity: .9; }
    th.sortable.sort-desc::after { content: '▼'; opacity: .9; }
    th.sortable.sort-active { color: var(--accent); }

    /* 直列框選 */
    body.selecting { user-select: none; }
    td.sel { background: #fff3cd !important; }

    /* 通用 Modal */
    .modal{ position: fixed; inset:0; background: rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding: 16px; z-index: var(--z-modal); }
    .modal.show{ display:flex; }
    .modal-card{ background: var(--bg); color: var(--fg); border: 1px solid var(--border); border-radius: 12px; max-width: 680px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,.2); }
    .modal-card header{ padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #e3e9f3; }
    .modal-card .content{ max-height: 55vh; overflow: auto; padding: 12px 16px; }
    .modal-card footer{ padding: 12px 16px; display:flex; gap:8px; justify-content:flex-end; border-top: 1px solid #e3e9f3; }

    .sheet-list{ display:grid; gap:8px; }

    /* 欄位設定 UI */
    .cols-wrap { display: grid; gap: 10px; }
    .cols-note { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .cols-list { list-style: none; margin: 0; padding: 0; }
    .col-item { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--border); border-radius: 10px; background: var(--chip); }
    .col-item[draggable="true"] { cursor: move; }
    .col-item .drag { font-weight: 700; width: 1.2em; text-align: center; opacity: .7; }
    .col-item .label { flex: 1 1 auto; }
  </style>
</head>
<body>
  <header>
    <h1>BankSpot 欄位抽取器（HTML 本地執行） · V1.1</h1>
    <div class="sub">將不同版型的 Excel/CSV（銀行兩版、警察熱點明細）合併成統一欄位，並可自訂輸出欄位與順序。</div>
    <div class="bar">
      <label class="btn" for="file">選擇檔案（可多選）</label>
      <input id="file" type="file" accept=".xlsx,.xls,.csv" multiple />
      <button id="btn-clear" class="btn" type="button">清空結果</button>
      <button id="btn-export" class="btn" type="button" disabled>下載 CSV</button>
      <button id="btn-cols" class="btn" type="button" disabled>欄位設定（顯示/排序）</button>
    </div>
    <div id="drop" class="drop">拖曳 Excel / CSV 檔案到這裡（可多檔）</div>
  </header>

  <!-- 分頁選擇（工作表）對話盒 -->
  <div id="sheetModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <header>選擇要匯入的分頁</header>
      <div class="content">
        <div class="sub" id="sheetFileName" style="margin-bottom:8px;"></div>
        <div class="sheet-list" id="sheetList"></div>
      </div>
      <footer>
        <button id="sheetAll" class="btn" type="button">全選</button>
        <button id="sheetNone" class="btn" type="button">全不選</button>
        <button id="sheetCancel" class="btn" type="button">略過此檔</button>
        <button id="sheetOk" class="btn" type="button">確定</button>
      </footer>
    </div>
  </div>

  <!-- 欄位設定（顯示/排序）對話盒 -->
  <div id="colsModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <header>欄位設定（顯示/排序）</header>
      <div class="content">
        <div class="cols-wrap">
          <div class="cols-note">拖曳左側把手可調整順序；勾選代表輸出該欄。若未更動，維持預設 7 欄順序。</div>
          <ul id="colsList" class="cols-list"></ul>
        </div>
      </div>
      <footer>
        <button id="colsDefault" class="btn" type="button">恢復預設</button>
        <button id="colsCancel" class="btn" type="button">取消</button>
        <button id="colsOk" class="btn" type="button">套用</button>
      </footer>
    </div>
  </div>

  <main>
    <div class="meta">
      <span class="chip" id="file-count">未載入檔案</span>
      <span class="chip" id="row-count">0 筆資料</span>
      <span class="tips">支援：可選擇分頁（工作表）；首列為欄名；欄位可顯示/排序。</span>
    </div>

    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr id="thead-row"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <details class="help">
      <summary>欄位對應與格式規則（點開看）</summary>
      <ol>
        <li><strong>帳號</strong>：銀行表用「帳號」，舊式熱點明細用「人頭帳戶」。</li>
        <li><strong>交易日期</strong>：銀行表用「交易日期」，熱點明細用「提款日期」。若為 <code>YYYYMMDD</code>（如 <code>20250408</code>），轉換為民國格式 <code>114/04/08</code>；若為民國 7 碼（如 <code>1140408</code>），保留為 <code>114/04/08</code>；亦支援 Excel 日期序號。</li>
        <li><strong>交易時間</strong>：銀行表用「交易時間」，熱點明細用「提款時間」。<code>hhmmss</code>（如 <code>130700</code>）轉 <code>13:07:00</code>；<code>hhmm</code> 轉 <code>hh:mm:00</code>；亦支援 Excel 時分秒序號。</li>
        <li><strong>支出金額</strong>：銀行表用「支出金額」，熱點明細用「提款金額」。去除正負號與小數（<code>+100.00</code> → <code>100</code>）。金額 ≥ 10,000 以「萬」表示（例如 <code>23,000</code> → <code>2萬3,000</code>；<code>20,000</code> → <code>2萬</code>）。</li>
        <li><strong>存入金額</strong>：銀行表為「存入金額」，熱點明細無此欄則輸出 <code>0</code>。</li>
        <li><strong>ATM編號</strong>：銀行表可能為「ATM或端末機代碼」，熱點明細為「ATM編號」。</li>
        <li><strong>提款地點</strong>：熱點明細為「提款地點」。無對應欄位則輸出 <code>0</code>。</li>
      </ol>
    </details>
  </main>

  <script>
    // =========================
    // 設定與狀態
    // =========================
    const DEFAULT_HEADERS = ['帳號','交易日期','交易時間','支出金額','存入金額','ATM編號','提款地點'];
    let activeHeaders = [...DEFAULT_HEADERS]; // 目前顯示/輸出的欄位順序（可被使用者變更）
    let headerChecks = Object.fromEntries(DEFAULT_HEADERS.map(h => [h, true])); // 每個欄位是否勾選

    const FIELD_MAP = {
      '帳號': ['帳號','人頭帳戶'],
      '交易日期': ['交易日期','提款日期'],
      '交易時間': ['交易時間','提款時間'],
      '支出金額': ['支出金額','提款金額'],
      '存入金額': ['存入金額'],
      'ATM編號': ['ATM編號','ATM或端末機代碼'],
      '提款地點': ['提款地點']
    };

    const elFile = document.getElementById('file');
    const elDrop = document.getElementById('drop');
    const elBody = document.getElementById('tbody');
    const elTheadRow = document.getElementById('thead-row');
    const elBtnExport = document.getElementById('btn-export');
    const elBtnClear = document.getElementById('btn-clear');
    const elBtnCols = document.getElementById('btn-cols');
    const elFileCount = document.getElementById('file-count');
    const elRowCount = document.getElementById('row-count');

    let mergedRows = []; // 全部資料（以 DEFAULT_HEADERS 順序保存）

    // 快速建立 Thead
    function renderThead() {
      elTheadRow.innerHTML = '';
      activeHeaders.forEach(name => {
        if (!headerChecks[name]) return; // 不顯示者略過
        const th = document.createElement('th');
        th.textContent = name === '交易日期' ? '交易日期（例：114/04/08）'
                        : name === '交易時間' ? '交易時間（例：13:07:00）'
                        : name;
        th.classList.add('sortable');
        elTheadRow.appendChild(th);
      });
      attachSortHandlers();
    }

    // =========================
    // 檔案選擇/拖放
    // =========================
    elFile.addEventListener('change', async (e) => { await handleFiles(e.target.files); elFile.value = ''; });

    ;['dragenter','dragover'].forEach(type => elDrop.addEventListener(type, (e) => { e.preventDefault(); e.stopPropagation(); elDrop.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(type => elDrop.addEventListener(type, (e) => { e.preventDefault(); e.stopPropagation(); elDrop.classList.remove('dragover'); }));
    elDrop.addEventListener('drop', async (e) => { await handleFiles(e.dataTransfer.files); });

    elBtnClear.addEventListener('click', () => { mergedRows = []; elBody.innerHTML = ''; elBtnExport.disabled = true; elBtnCols.disabled = true; elFileCount.textContent = '未載入檔案'; elRowCount.textContent = '0 筆資料'; renderThead(); });

    elBtnExport.addEventListener('click', () => { exportCSV(currentViewRows()); });
    elBtnCols.addEventListener('click', openColsModal);

    async function handleFiles(fileList) {
      if (!fileList || fileList.length === 0) return;
      elFileCount.textContent = `載入 ${fileList.length} 個檔案處理中…`;

      for (const file of fileList) {
        const arrayBuffer = await file.arrayBuffer();
        const wb = XLSX.read(arrayBuffer, { type: 'array' });
        const sheetNames = wb.SheetNames || [];

        let selectedSheets = sheetNames;
        if (sheetNames.length > 1) selectedSheets = await pickSheetsUI(file.name, sheetNames);
        if (!selectedSheets || selectedSheets.length === 0) continue;

        for (const name of selectedSheets) {
          const ws = wb.Sheets[name]; if (!ws) continue;
          const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
          if (!rows || rows.length === 0) continue;
          const header = normalizeHeaderRow(rows[0]);
          const dataRows = rows.slice(1);
          const picked = dataRows.map(r => pickAndFormatRow(header, r));
          mergedRows.push(...picked);
        }
        renderTable(currentViewRows());
        elBtnExport.disabled = mergedRows.length === 0;
        elBtnCols.disabled = mergedRows.length === 0;
        elRowCount.textContent = `${mergedRows.length} 筆資料`;
      }
      elBtnExport.disabled = mergedRows.length === 0;
      elBtnCols.disabled = mergedRows.length === 0;
      elFileCount.textContent = `已載入 ${fileList.length} 檔`;
      renderThead();
    }

    function normalizeHeaderRow(hdrRow) { return hdrRow.map((h) => String(h).trim()); }

    function pickAndFormatRow(headerRow, dataRow) {
      const obj = {}; for (let i=0;i<headerRow.length;i++){ const key = headerRow[i]||''; if(!key) continue; obj[key] = dataRow[i]; }
      const getFirst = (targets) => { for (const k of targets) { if (k in obj) { const v = obj[k]; if (v!=='' && v!==null && v!==undefined) return v; } } return null; };

      const raw = {
        帳號: getFirst(FIELD_MAP['帳號']),
        交易日期: getFirst(FIELD_MAP['交易日期']),
        交易時間: getFirst(FIELD_MAP['交易時間']),
        支出金額: getFirst(FIELD_MAP['支出金額']),
        存入金額: getFirst(FIELD_MAP['存入金額']),
        ATM編號: getFirst(FIELD_MAP['ATM編號']),
        提款地點: getFirst(FIELD_MAP['提款地點'])
      };
      // 依預設欄位順序保存（不受使用者重排影響）
      return [
        formatAccount(raw.帳號),
        formatROCDate(raw.交易日期),
        formatTime(raw.交易時間),
        formatAmount(raw.支出金額),
        formatAmount(raw.存入金額),
        formatText(raw.ATM編號),
        formatText(raw.提款地點)
      ];
    }

    function formatAccount(v){ if (v===null||v===undefined||String(v).trim()==='') return '0'; return String(v).trim(); }

    function formatROCDate(v){
      if (v===null||v===undefined||v==='') return '0';
      if (typeof v==='number' && v>30000 && v<60000 && XLSX && XLSX.SSF) { const d = XLSX.SSF.parse_date_code(v); if (d&&d.y&&d.m&&d.d){ const roc=d.y-1911; if(roc<=0) return '0'; return `${roc}/${String(d.m).padStart(2,'0')}/${String(d.d).padStart(2,'0')}`; } }
      const digits = String(v).replace(/[^\d]/g,'');
      if (digits.length===8){ const yyyy=parseInt(digits.slice(0,4),10); const mm=digits.slice(4,6); const dd=digits.slice(6,8); const roc=yyyy-1911; if(roc<=0) return '0'; return `${roc}/${mm}/${dd}`; }
      if (digits.length===7){ const yyy=digits.slice(0,3); const mm=digits.slice(3,5); const dd=digits.slice(5,7); return `${yyy}/${mm}/${dd}`; }
      const d2 = new Date(String(v)); if (!isNaN(d2.getTime())) { const yyyy=d2.getFullYear(); const mm=String(d2.getMonth()+1).padStart(2,'0'); const dd=String(d2.getDate()).padStart(2,'0'); const roc=yyyy-1911; if(roc<=0) return '0'; return `${roc}/${mm}/${dd}`; }
      return '0';
    }

    function formatTime(v){
      if (v===null||v===undefined||v==='') return '0';
      if (typeof v==='number'){
        if (v>0 && v<1 && XLSX && XLSX.SSF){ const totalSec=Math.round(v*24*60*60); const hh=String(Math.floor(totalSec/3600)).padStart(2,'0'); const mm=String(Math.floor((totalSec%3600)/60)).padStart(2,'0'); const ss=String(totalSec%60).padStart(2,'0'); return `${hh}:${mm}:${ss}`; }
        const s=String(Math.round(v)); return fmtTimeFromDigits(s);
      }
      const digits=String(v).replace(/[^\d]/g,''); return fmtTimeFromDigits(digits);
    }
    function fmtTimeFromDigits(s){ if (s.length===6) return `${s.slice(0,2)}:${s.slice(2,4)}:${s.slice(4,6)}`; if (s.length===4) return `${s.slice(0,2)}:${s.slice(2,4)}:00`; if (s.length===2) return `${s}:00:00`; return '0'; }

    function formatAmount(v){ if (v===null||v===undefined||v==='') return '0'; let s=String(v).trim(); s=s.replace(/,/g,''); const num=Math.abs(parseFloat(s.replace(/[^\d.-]/g,''))); if (isNaN(num)) return '0'; const n=Math.floor(num+1e-6); if (n<10000) return n.toLocaleString('zh-TW'); const w=Math.floor(n/10000); const r=n%10000; return r===0?`${w}萬`:`${w}萬${r.toLocaleString('zh-TW')}`; }
    function formatText(v){ if (v===null||v===undefined) return '0'; const s=String(v).trim(); return s===''?'0':s; }

    // 將 mergedRows 依目前 activeHeaders + 勾選情況回傳視圖列
    function currentViewRows(){
      const idxMap = DEFAULT_HEADERS.map((h, i) => [h, i]).reduce((acc,[h,i]) => (acc[h]=i, acc), {});
      const visible = activeHeaders.filter(h => headerChecks[h]);
      return mergedRows.map(row => visible.map(h => row[idxMap[h]]));
    }

    // 渲染表格
    function renderTable(rows) {
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');
        for (const cell of r) { const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td); }
        frag.appendChild(tr);
      }
      elBody.innerHTML = '';
      elBody.appendChild(frag);
      elRowCount.textContent = `${mergedRows.length} 筆資料`;
      // 重新掛上直列框選事件（tbody 內容變更後）
      setupColumnSelect();
    }

    // 匯出 CSV（依目前可見欄位與順序）
    function exportCSV(rows){ if (!rows||!rows.length) return; const header = activeHeaders.filter(h=>headerChecks[h]).join(','); const lines = rows.map(r => r.map(escapeCSV).join(',')); const csv = [header, ...lines].join('\r\n'); const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); a.download = `抽欄位_輸出_${ts}.csv`; a.click(); URL.revokeObjectURL(a.href); }
    function escapeCSV(v){ const s=String(v); if (s.includes(',')||s.includes('"')||s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"'; return s; }

    // 分頁選擇 UI
    function pickSheetsUI(fileName, sheetNames){
      return new Promise((resolve) => {
        const modal = document.getElementById('sheetModal');
        const list = document.getElementById('sheetList');
        const fn = document.getElementById('sheetFileName');
        const btnAll = document.getElementById('sheetAll');
        const btnNone = document.getElementById('sheetNone');
        const btnOk = document.getElementById('sheetOk');
        const btnCancel = document.getElementById('sheetCancel');

        fn.textContent = `檔案：${fileName}`;
        list.innerHTML = '';
        sheetNames.forEach((name) => {
          const wrap = document.createElement('label');
          wrap.style.display = 'flex'; wrap.style.alignItems='center'; wrap.style.gap='8px';
          const safe = escapeHtml(name);
          wrap.innerHTML = `<input type="checkbox" data-name="${safe}" checked> <span>${safe}</span>`;
          list.appendChild(wrap);
        });
        const collect = () => Array.from(list.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.getAttribute('data-name'));
        const close = (ret) => { document.removeEventListener('keydown', onKey); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); resolve(ret); };
        const onKey = (e) => { if (e.key==='Escape'){ e.preventDefault(); close([]); } if (e.key==='Enter'){ e.preventDefault(); close(collect()); } };
        btnAll.onclick = () => list.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);
        btnNone.onclick = () => list.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false);
        btnCancel.onclick = () => close([]);
        btnOk.onclick = () => close(collect());
        modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.addEventListener('keydown', onKey);
      });
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch])); }

    // =========================
    // 排序（動態欄位）
    // =========================
    let currentSort = { col: null, dir: 1 }; // 1: asc, -1: desc（針對可見欄位索引）

    function attachSortHandlers(){
      const ths = Array.from(document.querySelectorAll('#tbl thead th'));
      ths.forEach((th, idx) => {
        th.onclick = () => {
          if (currentSort.col === idx) currentSort.dir = -currentSort.dir; else { currentSort.col = idx; currentSort.dir = 1; }
          sortBy(idx, currentSort.dir);
          updateSortIndicators(ths, idx, currentSort.dir);
        };
      });
    }
    function updateSortIndicators(ths, activeIdx, dir){ ths.forEach((th,i)=>{ th.classList.remove('sort-asc','sort-desc','sort-active'); if (i===activeIdx){ th.classList.add('sort-active'); th.classList.add(dir===1?'sort-asc':'sort-desc'); } }); }

    function sortBy(colIdx, dir){
      // 需要根據可見欄位映射到 mergedRows 的原始欄位索引
      const visible = activeHeaders.filter(h => headerChecks[h]);
      const headerToIdx = Object.fromEntries(DEFAULT_HEADERS.map((h,i)=>[h,i]));
      const baseIdx = headerToIdx[visible[colIdx]];
      mergedRows.sort((a,b) => compareCells(a[baseIdx], b[baseIdx], baseIdx, dir));
      renderTable(currentViewRows());
    }

    function compareCells(a,b,colIdx,dir){
      const ka = makeKey(a, colIdx); const kb = makeKey(b, colIdx);
      const an = typeof ka==='number' && !isNaN(ka); const bn = typeof kb==='number' && !isNaN(kb);
      if (!an && !bn){ const r = String(ka).localeCompare(String(kb), 'zh-Hant', { numeric:true, sensitivity:'base' }); return dir===1? r : -r; }
      if (!an) return dir===1 ? 1 : -1; if (!bn) return dir===1 ? -1 : 1; return dir===1 ? (ka-kb) : (kb-ka);
    }
    function onlyDigits(str){ let out=''; for(let i=0;i<str.length;i++){ const ch=str[i]; if (ch>='0'&&ch<='9') out+=ch; } return out; }
    function makeKey(v,colIdx){ const s=String(v||'').trim(); if (s===''||s==='0') return NaN; if (colIdx===1) return parseROCDateKey(s); if (colIdx===2) return parseTimeKey(s); if (colIdx===3||colIdx===4) return parseAmountKey(s); return s.toLowerCase(); }
    function parseROCDateKey(s){ const p=s.split('/'); if (p.length!==3) return NaN; const y=parseInt(p[0],10)+1911; const mm=parseInt(p[1],10); const dd=parseInt(p[2],10); if (isNaN(y)||isNaN(mm)||isNaN(dd)) return NaN; return y*10000+mm*100+dd; }
    function parseTimeKey(s){ const t=s.split(':'); if (t.length!==3) return NaN; const hh=parseInt(t[0],10), mm=parseInt(t[1],10), ss=parseInt(t[2],10); if (isNaN(hh)||isNaN(mm)||isNaN(ss)) return NaN; return hh*3600+mm*60+ss; }
    function parseAmountKey(s){ if (s.indexOf('萬')!==-1){ const parts=s.split('萬'); const w=parseInt(onlyDigits(parts[0]),10)||0; const r=parseInt(onlyDigits(parts[1]||''),10)||0; return w*10000+r; } const n=parseInt(onlyDigits(s),10); return isNaN(n)?0:n; }

    // =========================
    // 直列框選（需配合可見欄位數）
    // =========================
    function setupColumnSelect(){
      const tbody = document.getElementById('tbody');
      let selecting=false, startRow=-1, colIdx=-1;
      function clearSelection(){ tbody.querySelectorAll('td.sel').forEach(td=>td.classList.remove('sel')); }
      function applySelection(col,r1,r2){ clearSelection(); const rows=tbody.querySelectorAll('tr'); const a=Math.max(0,Math.min(r1,r2)); const b=Math.min(rows.length-1,Math.max(r1,r2)); for(let i=a;i<=b;i++){ const td=rows[i]?.children[col]; if (td) td.classList.add('sel'); } }
      tbody.onmousedown = (e)=>{ const td=e.target.closest('td'); if(!td) return; const tr=td.parentElement; colIdx = Array.prototype.indexOf.call(tr.children, td); startRow = Array.prototype.indexOf.call(tbody.children, tr); selecting=true; document.body.classList.add('selecting'); applySelection(colIdx,startRow,startRow); e.preventDefault(); };
      tbody.onmouseover = (e)=>{ if(!selecting) return; const td=e.target.closest('td'); if(!td) return; const tr=td.parentElement; const hoverCol = Array.prototype.indexOf.call(tr.children, td); if (hoverCol!==colIdx) return; const row = Array.prototype.indexOf.call(tbody.children, tr); applySelection(colIdx,startRow,row); };
      window.onmouseup = ()=>{ if(!selecting) return; selecting=false; document.body.classList.remove('selecting'); };
    }

    // =========================
    // 欄位設定（顯示/排序）
    // =========================
    function openColsModal(){
      const modal = document.getElementById('colsModal');
      const list = document.getElementById('colsList');
      const btnOk = document.getElementById('colsOk');
      const btnCancel = document.getElementById('colsCancel');
      const btnDefault = document.getElementById('colsDefault');

      // 以目前 activeHeaders 的順序產生項目
      list.innerHTML = '';
      activeHeaders.forEach(h => {
        const li = document.createElement('li'); li.className='col-item'; li.setAttribute('draggable','true'); li.dataset.name = h;
        const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!headerChecks[h]; chk.onchange = () => headerChecks[h] = chk.checked;
        const drag = document.createElement('span'); drag.className='drag'; drag.textContent='≡';
        const label = document.createElement('span'); label.className='label'; label.textContent = h;
        li.appendChild(drag); li.appendChild(chk); li.appendChild(label);
        list.appendChild(li);
      });

      // 簡易拖曳排序（HTML5 DnD）
      let dragEl = null;
      list.addEventListener('dragstart', (e)=>{ const li=e.target.closest('.col-item'); if(!li) return; dragEl=li; e.dataTransfer.effectAllowed='move'; });
      list.addEventListener('dragover', (e)=>{ e.preventDefault(); const li=e.target.closest('.col-item'); if(!li||li===dragEl) return; const rect=li.getBoundingClientRect(); const mid=rect.top+rect.height/2; if (e.clientY<mid) list.insertBefore(dragEl, li); else list.insertBefore(dragEl, li.nextSibling); });
      list.addEventListener('dragend', ()=>{ dragEl=null; });

      const close = ()=>{ document.removeEventListener('keydown', onKey); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); };
      const onKey = (e)=>{ if(e.key==='Escape'){ e.preventDefault(); close(); } if(e.key==='Enter'){ e.preventDefault(); applyAndClose(); } };

      function applyAndClose(){
        // 讀取目前列表順序
        const order = Array.from(list.querySelectorAll('.col-item')).map(li => li.dataset.name);
        activeHeaders = order;
        // 若全數取消勾選，視為維持原預設全部顯示
        const anyChecked = Object.values(headerChecks).some(v=>v);
        if (!anyChecked){ headerChecks = Object.fromEntries(DEFAULT_HEADERS.map(h=>[h,true])); activeHeaders = [...DEFAULT_HEADERS]; }
        renderThead();
        renderTable(currentViewRows());
        close();
      }

      btnDefault.onclick = ()=>{ headerChecks = Object.fromEntries(DEFAULT_HEADERS.map(h=>[h,true])); activeHeaders = [...DEFAULT_HEADERS]; renderThead(); renderTable(currentViewRows()); close(); };
      btnCancel.onclick = ()=> close();
      btnOk.onclick = ()=> applyAndClose();

      modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); document.addEventListener('keydown', onKey);
    }

    // 初始表頭（尚無資料時仍顯示預設）
    renderThead();
  </script>
</body>
</html>
