<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BankSpot 欄位抽取器 · V1.2（Consolidated）</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root{
    color-scheme: light dark;
    --bg:#0b0d10; --fg:#e9eef5; --muted:#9aa8b6; --chip:#182232;
    --panel:#0f1318; --border:#223042; --soft:#101621;
    --accent:#5aa7ff; --accent-2:#7bd7ff;
    --ok:#18b778; --warn:#ffb24d; --err:#ff6b7a;
    --thead:#101926; --thead-border:#1b2a3d;
    --row:#0e141d; --row-alt:#0c121a;
    --hover:#122033; --drag:#0f2039;
    --row-in:#0f1f18; --row-out:#231513;
    --row-in-lt:#e7fff1; --row-out-lt:#fff0ec;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f7fbff; --fg:#152033; --muted:#516179; --chip:#ecf3ff;
      --panel:#ffffff; --border:#d5e3f7; --soft:#eff6ff;
      --accent:#0b5cdb; --accent-2:#3290ff;
      --ok:#0a7b32; --warn:#b45e00; --err:#b00020;
      --thead:#f1f6ff; --thead-border:#e0ecff;
      --row:#ffffff; --row-alt:#f9fbff;
      --hover:#eef5ff; --drag:#e6f0ff;
    }
  }
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC","Microsoft JhengHei", Arial, "PingFang TC", sans-serif;
    display:grid; grid-template-rows:auto 1fr; gap:12px;
  }
  header{padding:16px 16px 0}
  h1{margin:0 0 6px; font-size:20px; display:flex; align-items:center; gap:10px}
  .sub{color:var(--muted); font-size:13px}

  .bar{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:12px}
  .btn, label.btn{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px;
    border:1px solid var(--border); border-radius:10px;
    background:linear-gradient(180deg, var(--chip), var(--soft));
    color:var(--fg); cursor:pointer; user-select:none; box-shadow:var(--shadow);
  }
  .btn:disabled{opacity:.55; cursor:not-allowed; box-shadow:none}
  input[type="file"]{display:none}
  .drop{margin:12px 16px 0; padding:18px; border:2px dashed var(--border); border-radius:12px;
    text-align:center; color:var(--muted); transition:.2s ease; background:var(--panel); box-shadow:var(--shadow)}
  .drop.dragover{ background:var(--drag); border-color:var(--accent); color:var(--fg)}

  .filters{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-top:10px}
  .input{padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--panel); color:var(--fg)}

  main{min-height:0; display:grid; grid-template-rows:auto 1fr; gap:8px; padding:0 16px 16px}
  .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; font-size:13px; color:var(--muted)}
  .chip{background:linear-gradient(180deg, var(--chip), var(--soft)); border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:var(--fg)}
  .tips{font-size:12px; color:var(--muted)}

  .table-wrap{min-height:0; overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--panel); box-shadow:var(--shadow)}
  table{border-collapse:separate; border-spacing:0; width:100%; font-size:14px}
  thead th{
    position:sticky; top:0; text-align:left; font-weight:600; padding:10px;
    background:var(--thead); color:var(--fg); border-bottom:1px solid var(--thead-border);
    white-space:nowrap; user-select:none;
  }
  tbody td{ border-bottom:1px solid var(--border); padding:8px 10px; white-space:nowrap; background:var(--row); transition:background .15s ease }
  tbody tr:nth-child(2n) td{ background:var(--row-alt)}
  tbody tr:hover td{ background:var(--hover)}
  tr.row-in td{ background:var(--row-in) }
  tr.row-out td{ background:var(--row-out) }
  @media (prefers-color-scheme: light){
    tr.row-in td{ background:var(--row-in-lt) }
    tr.row-out td{ background:var(--row-out-lt) }
  }

  th.sortable{cursor:pointer}
  th.sortable .sort-icon{opacity:.45; margin-left:6px; font-size:12px}
  th.sortable.sort-active{color:var(--accent)}
  th.sortable.sort-asc .sort-icon::after{content:'▲'; opacity:.9}
  th.sortable.sort-desc .sort-icon::after{content:'▼'; opacity:.9}
  th.sortable:not(.sort-asc):not(.sort-desc) .sort-icon::after{content:'↕'}
  .drag-handle{display:inline-flex; align-items:center; justify-content:center; width:16px; height:16px; margin-right:6px; opacity:.6; cursor:grab}
  th.dragging{opacity:.6; background:var(--drag)}

  /* 多選視覺 */
  td.sel{ background:rgba(99, 165, 255, .25) !important; outline:1px solid rgba(99,165,255,.6) }

  /* 模式 Segmented Control */
  .segments{ display:inline-flex; border:1px solid var(--border); border-radius:12px; overflow:hidden; box-shadow:var(--shadow); background:var(--panel) }
  .seg{ padding:8px 12px; cursor:pointer; user-select:none; }
  .seg.active{ background:var(--chip); color:var(--fg); font-weight:600; }

  /* Modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:16px; z-index:999 }
  .modal.show{ display:flex }
  .modal-card{ background:var(--panel); color:var(--fg); border:1px solid var(--border); border-radius:14px; width:min(780px, 100%); box-shadow:var(--shadow) }
  .modal-card header{ padding:12px 16px; font-weight:700; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px }
  .modal-card .content{ max-height:60vh; overflow:auto; padding:12px 16px }
  .modal-card footer{ padding:12px 16px; display:flex; gap:8px; justify-content:flex-end; border-top:1px solid var(--border) }
  .sheet-list{ display:grid; gap:8px }
  .sheet-list label{ display:flex; align-items:center; gap:8px }
  .col-list{ display:grid; gap:8px }
  .col-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:linear-gradient(180deg, var(--chip), var(--soft)) }
  .col-item[draggable="true"]{ cursor:grab }
  .col-item.dragover{ outline:2px dashed var(--accent) }
</style>
</head>
<body>
<header>
  <h1>BankSpot 欄位抽取器 · V1.2（Consolidated）</h1>
  <div class="sub">離線單檔｜日期篩選｜存入/領出上色｜統一欄位 / 來源欄位｜欄位拖曳＋排序｜矩形多選複製｜CSV 匯出</div>

  <div class="bar">
    <label class="btn" for="file">選擇檔案（可多選）</label>
    <input id="file" type="file" accept=".xlsx,.xls,.csv,.xlsm" multiple />

    <div class="segments" id="modeSeg">
      <div class="seg active" data-mode="normalized">統一欄位</div>
      <div class="seg" data-mode="raw">來源欄位</div>
    </div>

    <button id="btn-cols" class="btn" type="button" title="（統一欄位）選擇顯示欄位與順序">選擇欄位</button>
    <button id="btn-raw-cols" class="btn" type="button" title="（來源欄位）勾選原始欄位並排序" style="display:none">選擇來源欄位</button>

    <button id="btn-clear" class="btn" type="button">清空結果</button>
    <button id="btn-copy" class="btn" type="button" disabled title="複製所選（Ctrl/⌘+C）">複製所選</button>
    <button id="btn-export" class="btn" type="button" disabled title="匯出 CSV">下載 CSV</button>
  </div>

  <div class="filters">
    <input id="dateFrom" class="input" type="date" />
    <span>～</span>
    <input id="dateTo" class="input" type="date" />
    <button id="btn-apply-date" class="btn" type="button">套用日期篩選</button>
    <button id="btn-reset-date" class="btn" type="button">清除日期</button>
  </div>

  <div id="drop" class="drop">拖曳 Excel / CSV / XLSM 檔案到這裡（可多檔）</div>
</header>

<!-- 分頁選擇 -->
<div id="sheetModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <header>選擇要匯入的分頁</header>
    <div class="content"><div id="sheetFileName" class="sub" style="margin-bottom:8px;"></div><div class="sheet-list" id="sheetList"></div></div>
    <footer>
      <button id="sheetAll" class="btn" type="button">全選</button>
      <button id="sheetNone" class="btn" type="button">全不選</button>
      <button id="sheetCancel" class="btn" type="button">略過此檔</button>
      <button id="sheetOk" class="btn" type="button">確定</button>
    </footer>
  </div>
</div>

<!-- 統一欄位 -->
<div id="colModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <header>選擇輸出欄位與順序（統一欄位）</header>
    <div class="content"><div class="col-list" id="colList"></div></div>
    <footer>
      <button id="colReset" class="btn" type="button">重設預設順序</button>
      <button id="colCancel" class="btn" type="button">取消</button>
      <button id="colApply" class="btn" type="button">套用</button>
    </footer>
  </div>
</div>

<!-- 來源欄位 -->
<div id="rawColModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <header>選擇輸出欄位與順序（來源欄位）</header>
    <div class="content">
      <p class="sub" style="margin:0 0 8px">以下為你載入檔案的所有原始標題（Union）。勾選需要的欄位；拖曳可改順序。</p>
      <div class="col-list" id="rawColList"></div>
    </div>
    <footer>
      <button id="rawColAll" class="btn" type="button">全選</button>
      <button id="rawColNone" class="btn" type="button">全不選</button>
      <button id="rawColCancel" class="btn" type="button">取消</button>
      <button id="rawColApply" class="btn" type="button">套用</button>
    </footer>
  </div>
</div>

<main>
  <div class="meta">
    <span class="chip" id="file-count">未載入檔案</span>
    <span class="chip" id="row-count">0 筆資料</span>
    <span class="chip" id="mode-chip">模式：統一欄位</span>
    <span class="tips">可用滑鼠拖曳「矩形」選取；按住 Ctrl/⌘ 可以多選。Ctrl/⌘+C 直接複製。</span>
  </div>
  <div class="table-wrap">
    <table id="tbl">
      <thead><tr id="thead-row"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
/* ================== 常數/狀態 ================== */
const OUTPUT_HEADERS = ['帳號','交易日期','交易時間','支出金額','存入金額','ATM編號','提款地點'];
const FIELD_MAP = {
  '帳號': ['帳號','人頭帳戶'],
  '交易日期': ['交易日期','提款日期'],
  '交易時間': ['交易時間','提款時間'],
  '支出金額': ['支出金額','提款金額','交易金額'], // 映射補齊
  '存入金額': ['存入金額'],
  'ATM編號': ['ATM編號','ATM或端末機代碼'],
  '提款地點': ['提款地點']
};

let mode = 'normalized';                 // normalized | raw
let visibleCols = OUTPUT_HEADERS.map((_, i) => i);
let colEnabled  = OUTPUT_HEADERS.map(() => true);
let rawUnionHeaders = [];
let rawSelectedHeaders = [];

const normalizedRows = []; // { vals:[7], dateKey, inAmt, outAmt }
const rawRows = [];        // { data:{},  dateKey, inAmt, outAmt }

let filterFrom = null; // YYYYMMDD number
let filterTo   = null;

/* ================== 元素快取 ================== */
const elFile = document.getElementById('file');
const elDrop = document.getElementById('drop');
const elBody = document.getElementById('tbody');
const elHeadRow = document.getElementById('thead-row');
const elBtnExport = document.getElementById('btn-export');
const elBtnClear = document.getElementById('btn-clear');
const elBtnCopy  = document.getElementById('btn-copy');
const elFileCount = document.getElementById('file-count');
const elRowCount  = document.getElementById('row-count');
const elModeChip  = document.getElementById('mode-chip');
const elBtnCols   = document.getElementById('btn-cols');
const elBtnRawCols= document.getElementById('btn-raw-cols');

/* ================== 模式 Segmented Control ================== */
document.querySelectorAll('#modeSeg .seg').forEach(seg=>{
  seg.addEventListener('click', ()=>{
    document.querySelectorAll('#modeSeg .seg').forEach(s=>s.classList.remove('active'));
    seg.classList.add('active');
    mode = seg.dataset.mode;
    elModeChip.textContent = '模式：' + (mode==='normalized'?'統一欄位':'來源欄位');
    elBtnCols.style.display = (mode==='normalized') ? '' : 'none';
    elBtnRawCols.style.display = (mode==='raw') ? '' : 'none';
    renderTable();
  });
});

/* ================== 檔案載入 ================== */
elFile.addEventListener('change', async (e) => { await handleFiles(e.target.files); e.target.value=''; });
['dragenter','dragover'].forEach(t => elDrop.addEventListener(t, (e) => { e.preventDefault(); e.stopPropagation(); elDrop.classList.add('dragover'); }));
['dragleave','drop'].forEach(t => elDrop.addEventListener(t, (e) => { e.preventDefault(); e.stopPropagation(); elDrop.classList.remove('dragover'); }));
elDrop.addEventListener('drop', async (e) => { await handleFiles(e.dataTransfer.files); });

elBtnClear.addEventListener('click', () => {
  normalizedRows.length = 0; rawRows.length = 0;
  rawUnionHeaders = []; rawSelectedHeaders = [];
  elBody.innerHTML = ''; elBtnExport.disabled = true; elBtnCopy.disabled = true;
  elFileCount.textContent = '未載入檔案'; elRowCount.textContent = '0 筆資料';
  renderHead();
});

elBtnExport.addEventListener('click', () => exportCSV(getDisplayRows(), getDisplayHeaders()));

async function handleFiles(fileList){
  if (!fileList || !fileList.length) return;
  elFileCount.textContent = `載入 ${fileList.length} 個檔案處理中…`;

  for (const file of fileList) {
    const arrayBuffer = await file.arrayBuffer();
    const wb = XLSX.read(arrayBuffer, { type:'array' });
    const sheets = wb.SheetNames || [];
    let selectedSheets = [];

    // 有「整理總表-更新版」就優先載它
    if (sheets.includes('整理總表-更新版')) selectedSheets = ['整理總表-更新版'];
    else if (sheets.length <= 1) selectedSheets = sheets.length ? [sheets[0]] : [];
    else selectedSheets = await pickSheetsUI(file.name, sheets);

    if (!selectedSheets || !selectedSheets.length) continue;

    for (const name of selectedSheets) {
      const ws = wb.Sheets[name]; if (!ws) continue;
      const rows = XLSX.utils.sheet_to_json(ws, { header:1, raw:true, defval:'' });
      if (!rows || !rows.length) continue;
      const header = normalizeHeaderRow(rows[0]);
      const dataRows = rows.slice(1);

      // 累積 union 原始標題
      header.forEach(h => { const t=String(h).trim(); if (t && !rawUnionHeaders.includes(t)) rawUnionHeaders.push(t) });

      for (const r of dataRows){
        const rawObj = {};
        for (let i=0;i<header.length;i++){ const key = header[i] || ''; if (!key) continue; rawObj[key] = r[i]; }

        const uni = pickAndFormatRow(header, r);
        const dKey = parseDateKeyFromUnified(uni[1]);
        const inAmtN = amountToNumber(uni[4]);
        const outAmtN= amountToNumber(uni[3]);

        normalizedRows.push({ vals:uni, dateKey:dKey, inAmt:inAmtN, outAmt:outAmtN });
        rawRows.push({ data:rawObj, dateKey:dKey, inAmt:inAmtN, outAmt:outAmtN });
      }
    }
    renderTable();
    elBtnExport.disabled = (normalizedRows.length === 0);
    elRowCount.textContent = `${normalizedRows.length} 筆資料`;
  }
  elBtnExport.disabled = (normalizedRows.length === 0);
  elFileCount.textContent = `已載入 ${fileList.length} 檔`;
}

/* ================== 欄位擷取/格式 ================== */
function normalizeHeaderRow(hdr){ return hdr.map(h => String(h).trim()) }

function pickAndFormatRow(headerRow, dataRow){
  const obj = {};
  for (let i=0;i<headerRow.length;i++){ const key = headerRow[i] || ''; if (!key) continue; obj[key] = dataRow[i]; }

  const getFirst = (cands) => { for (const k of cands){ if (k in obj){ const v=obj[k]; if (v!==''&&v!==null&&v!==undefined) return v; } } return null; };

  const rawAcct = getFirst(FIELD_MAP['帳號']);
  const rawDate = getFirst(FIELD_MAP['交易日期']);
  const rawTime = getFirst(FIELD_MAP['交易時間']);
  const rawOut  = getFirst(FIELD_MAP['支出金額']);
  const rawIn   = getFirst(FIELD_MAP['存入金額']);
  const rawATM  = getFirst(FIELD_MAP['ATM編號']);
  const rawLoc  = getFirst(FIELD_MAP['提款地點']);

  return [
    formatAccount(rawAcct),
    formatROCDateSafe(rawDate),
    formatTimeSafe(rawTime),
    formatAmount(rawOut),
    formatAmount(rawIn),
    formatText(rawATM),
    formatText(rawLoc)
  ];
}

function formatAccount(v){ return (v===null||v===undefined||String(v).trim()==='')?'0':String(v).trim() }

function formatROCDateSafe(v){
  if (v===null || v===undefined || v==='') return '0';
  if (typeof v === 'number' && v >= 1 && XLSX?.SSF){
    const d = XLSX.SSF.parse_date_code(v);
    if (d?.y && d?.m && d?.d){ const roc=d.y-1911; if (roc<=0) return '0'; return `${roc}/${String(d.m).padStart(2,'0')}/${String(d.d).padStart(2,'0')}`; }
  }
  let s = String(v).trim().replace(/[．。.-]/g,'/').replace(/／/g,'/');
  const d2 = new Date(s);
  if (!isNaN(d2.getTime())){
    const yyyy = d2.getFullYear(), mm = String(d2.getMonth()+1).padStart(2,'0'), dd = String(d2.getDate()).padStart(2,'0');
    const roc = yyyy - 1911; if (roc<=0) return '0';
    return `${roc}/${mm}/${dd}`;
  }
  const digits = s.replace(/[^\d]/g,'');
  if (digits.length===8){
    const yyyy = parseInt(digits.slice(0,4),10); const mm=digits.slice(4,6); const dd=digits.slice(6,8);
    const roc = yyyy-1911; if (roc<=0) return '0';
    return `${roc}/${mm}/${dd}`;
  }
  if (digits.length===7){
    const yyy = digits.slice(0,3); const mm=digits.slice(3,5); const dd=digits.slice(5,7);
    return `${yyy}/${mm}/${dd}`;
  }
  const m = s.match(/^(\d{3})[\/](\d{1,2})[\/](\d{1,2})$/);
  if (m){ const yyy=m[1], mm=m[2].padStart(2,'0'), dd=m[3].padStart(2,'0'); return `${yyy}/${mm}/${dd}`; }
  return '0';
}

function formatTimeSafe(v){
  if (v===null||v===undefined||v==='') return '0';
  if (typeof v==='number'){
    if (v>0 && v<1 && XLSX?.SSF){
      const totalSec = Math.round(v * 24 * 60 * 60);
      const hh = String(Math.floor(totalSec/3600)).padStart(2,'0');
      const mm = String(Math.floor((totalSec%3600)/60)).padStart(2,'0');
      const ss = String(totalSec%60).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }
    return timeFromDigits(String(Math.round(v)));
  }
  const digits = String(v).replace(/[^\d]/g,'');
  if (digits.length>=2) return timeFromDigits(digits);
  return '0';
}
function timeFromDigits(s){
  if (s.length===6) return `${s.slice(0,2)}:${s.slice(2,4)}:${s.slice(4,6)}`;
  if (s.length===4) return `${s.slice(0,2)}:${s.slice(2,4)}:00`;
  if (s.length===2) return `${s}:00:00`;
  return '0';
}

function formatAmount(v){
  if (v===null||v===undefined||v==='') return '0';
  let s = String(v).trim().replace(/,/g,'');
  const num = Math.abs(parseFloat(s.replace(/[^\d.-]/g,'')));
  if (isNaN(num)) return '0';
  const n = Math.floor(num + 1e-6);
  if (n<10000) return n.toLocaleString('zh-TW');
  const w = Math.floor(n/10000), r = n%10000;
  return r===0 ? `${w}萬` : `${w}萬${r.toLocaleString('zh-TW')}`;
}
function amountToNumber(s){
  s = String(s||'').trim();
  if (s==='0'||s==='') return 0;
  if (s.includes('萬')){
    const [wPart, rest=''] = s.split('萬');
    const w = parseInt(wPart.replace(/[^\d]/g,''),10)||0;
    const r = parseInt(rest.replace(/[^\d]/g,''),10)||0;
    return w*10000 + r;
  }
  const n = parseInt(s.replace(/[^\d]/g,''),10);
  return isNaN(n)?0:n;
}
function formatText(v){ if (v===null||v===undefined) return '0'; const s=String(v).trim(); return s===''?'0':s }

function parseDateKeyFromUnified(rocStr){
  const p = String(rocStr).split('/');
  if (p.length!==3) return NaN;
  const y = parseInt(p[0],10)+1911, m=parseInt(p[1],10), d=parseInt(p[2],10);
  if (isNaN(y)||isNaN(m)||isNaN(d)) return NaN;
  return y*10000 + m*100 + d;
}

/* ================== 日期篩選 ================== */
document.getElementById('btn-apply-date').onclick = applyDateFilter;
document.getElementById('btn-reset-date').onclick = resetDateFilter;
function applyDateFilter(){
  const f = document.getElementById('dateFrom').value ? Number(document.getElementById('dateFrom').value.replace(/-/g,'')) : null;
  const t = document.getElementById('dateTo').value   ? Number(document.getElementById('dateTo').value.replace(/-/g,''))   : null;
  filterFrom = f; filterTo = t; renderTable();
}
function resetDateFilter(){ document.getElementById('dateFrom').value=''; document.getElementById('dateTo').value=''; filterFrom=null; filterTo=null; renderTable(); }
function passDateFilter(dateKey){
  if (isNaN(dateKey)) return true;
  if (filterFrom && dateKey < filterFrom) return false;
  if (filterTo && dateKey > filterTo) return false;
  return true;
}

/* ================== 亂碼修復（來源欄位顯示用） ================== */
function countCJK(str){ return (String(str).match(/[\u4E00-\u9FFF]/g)||[]).length; }
function tryDecodeLatin1ToUTF8(s){ try { return decodeURIComponent(escape(s)); } catch(e){ return s; } }
function tryEncodeUTF8ToLatin1(s){ try { return unescape(encodeURIComponent(s)); } catch(e){ return s; } }
function fixEncoding(s){
  const a = String(s);
  const b = tryDecodeLatin1ToUTF8(a);
  const c = tryEncodeUTF8ToLatin1(a);
  const cand = [a,b,c];
  cand.sort((x,y)=> countCJK(y)-countCJK(x) || Math.abs(y.length-a.length)-Math.abs(x.length-a.length));
  return cand[0];
}

/* ================== 顯示資料 ================== */
function inferTypeByHeader(h){
  const s = String(h);
  if (s.includes('日期')) return 'date';
  if (s.includes('時間')) return 'time';
  if (s.includes('金額')) return 'amount';
  return 'text';
}
function getDisplayHeaders(){
  if (mode==='normalized'){
    return visibleCols.filter(i=>colEnabled[i]).map(i=>OUTPUT_HEADERS[i]);
  } else {
    return rawSelectedHeaders.map(h => fixEncoding(h)); // 顯示修復後
  }
}
function stringifyRaw(v){ if (v===null||v===undefined) return ''; return String(v); }
function getDisplayRows(){
  const rows = [];
  if (mode==='normalized'){
    const order = visibleCols.filter(i=>colEnabled[i]);
    for (const r of normalizedRows){ if (!passDateFilter(r.dateKey)) continue; rows.push(order.map(i => r.vals[i])); }
  } else {
    for (const r of rawRows){
      if (!passDateFilter(r.dateKey)) continue;
      const out = [];
      for (const key of rawSelectedHeaders){
        const v = r.data[key];
        switch(inferTypeByHeader(key)){
          case 'date':  out.push(formatROCDateSafe(v)); break;
          case 'time':  out.push(formatTimeSafe(v));    break;
          case 'amount':out.push(formatAmount(v));      break;
          default:      out.push(stringifyRaw(v));
        }
      }
      rows.push(out);
    }
  }
  return rows;
}

/* ================== 繪製 ================== */
function renderHead(){
  elHeadRow.innerHTML = '';
  const headers = getDisplayHeaders();
  headers.forEach((name, idx) => {
    const th = document.createElement('th');
    th.draggable = true; th.classList.add('sortable');

    if (mode==='normalized'){
      const colIdx = visibleCols.filter(i=>colEnabled[i])[idx];
      th.dataset.col = String(colIdx);
    } else {
      th.dataset.raw='1';
      th.dataset.key = rawSelectedHeaders[idx]; // 內部用原 key；顯示用已 fixEncoding 的 name
    }

    const handle = document.createElement('span'); handle.className = 'drag-handle';
    handle.innerHTML = '<svg viewBox="0 0 24 24" width="14" height="14"><path d="M9 6h6M9 10h6M9 14h6M9 18h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>';
    const title = document.createElement('span'); title.textContent = name;
    const sortIcon = document.createElement('span'); sortIcon.className = 'sort-icon';
    th.appendChild(handle); th.appendChild(title); th.appendChild(sortIcon);
    elHeadRow.appendChild(th);
  });
  attachSortHandlers();
  attachDragHeaders();
}

function renderTable(){
  // 清空選取，避免索引錯位
  clearSelection();

  renderHead();
  const rows = getDisplayRows();

  // 過濾後索引（供列上色）
  const filteredIdx = normalizedRows.map((r, i) => ({i, ok: passDateFilter(r.dateKey)})).filter(x => x.ok).map(x => x.i);

  const frag = document.createDocumentFragment();
  for (let ri=0; ri<rows.length; ri++){
    const r = rows[ri];
    const tr = document.createElement('tr');

    const src = normalizedRows[ filteredIdx[ri] ];
    if (src){
      if (src.inAmt > 0 && src.outAmt <= 0) tr.classList.add('row-in');
      if (src.outAmt > 0 && src.inAmt <= 0) tr.classList.add('row-out');
    }

    for (const cell of r){ const td=document.createElement('td'); td.textContent = cell; tr.appendChild(td); }
    frag.appendChild(tr);
  }
  elBody.innerHTML = ''; elBody.appendChild(frag);
  elRowCount.textContent = `${normalizedRows.length} 筆資料`;

  // 複製按鈕是否可用
  elBtnCopy.disabled = elBody.querySelectorAll('tr').length === 0;
}

/* ================== 匯出 ================== */
function exportCSV(rows, headers){
  if (!rows?.length) return;
  const header = headers.join(',');
  const lines = rows.map(r => r.map(escapeCSV).join(','));
  const csv = [header, ...lines].join('\r\n');
  const blob = new Blob(["\uFEFF"+csv], {type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); a.download = `抽欄位_輸出_${ts}.csv`; a.click();
  URL.revokeObjectURL(a.href);
}
function escapeCSV(v){
  const s = String(v ?? '');
  if (s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

/* ================== 排序 ================== */
let currentSort = { col:null, dir:1, rawKey:null };
function attachSortHandlers(){
  const ths = elHeadRow.querySelectorAll('th');
  ths.forEach((th) => {
    th.classList.remove('sort-asc','sort-desc','sort-active');
    th.addEventListener('click', (e) => {
      if (e.target.closest('.drag-handle')) return;

      if (mode==='normalized'){
        const internalCol = parseInt(th.dataset.col,10);
        if (currentSort.col === internalCol){ currentSort.dir = -currentSort.dir; }
        else { currentSort.col = internalCol; currentSort.rawKey = null; currentSort.dir = 1; }
        sortNormalized(currentSort.col, currentSort.dir);
        updateSortIndicatorsNormalized(currentSort.col, currentSort.dir);
      } else {
        const key = th.dataset.key;
        if (currentSort.rawKey === key){ currentSort.dir = -currentSort.dir; }
        else { currentSort.rawKey = key; currentSort.col = null; currentSort.dir = 1; }
        sortRawByKey(key, currentSort.dir);
        updateSortIndicatorsRaw(key, currentSort.dir);
      }
    });
  });
}
function updateSortIndicatorsNormalized(activeInternalCol, dir){
  const ths = elHeadRow.querySelectorAll('th');
  ths.forEach((th)=>{ th.classList.remove('sort-asc','sort-desc','sort-active');
    if (parseInt(th.dataset.col,10) === activeInternalCol) th.classList.add('sort-active', dir===1?'sort-asc':'sort-desc'); });
}
function updateSortIndicatorsRaw(activeKey, dir){
  const ths = elHeadRow.querySelectorAll('th');
  ths.forEach((th)=>{ th.classList.remove('sort-asc','sort-desc','sort-active');
    if (th.dataset.key === activeKey) th.classList.add('sort-active', dir===1?'sort-asc':'sort-desc'); });
}
function makeKeyForNormalized(s,colIdx){
  s = String(s||'').trim();
  if (s===''||s==='0') return NaN;
  if (colIdx===1){ const p = s.split('/'); if (p.length!==3) return NaN;
    const y = parseInt(p[0],10)+1911, m=parseInt(p[1],10), d=parseInt(p[2],10);
    if (isNaN(y)||isNaN(m)||isNaN(d)) return NaN; return y*10000 + m*100 + d; }
  if (colIdx===2){ const t = s.split(':'); if (t.length!==3) return NaN;
    const hh=parseInt(t[0],10), mm=parseInt(t[1],10), ss=parseInt(t[2],10);
    if (isNaN(hh)||isNaN(mm)||isNaN(ss)) return NaN; return hh*3600+mm*60+ss; }
  if (colIdx===3 || colIdx===4){
    if (s.includes('萬')){ const [wPart, rest=''] = s.split('萬');
      const w = parseInt(wPart.replace(/[^\d]/g,''),10)||0; const r = parseInt((rest||'').replace(/[^\d]/g,''),10)||0;
      return w*10000 + r; }
    const n = parseInt(s.replace(/[^\d]/g,''),10); return isNaN(n) ? 0 : n;
  }
  return s.toLowerCase();
}
function compareCells(a,b,colIdx,dir){
  const ka = makeKeyForNormalized(a,colIdx), kb = makeKeyForNormalized(b,colIdx);
  const an = (typeof ka === 'number' && !isNaN(ka));
  const bn = (typeof kb === 'number' && !isNaN(kb));
  if (!an && !bn) {
    const r = String(a).localeCompare(String(b),'zh-Hant',{numeric:true, sensitivity:'base'});
    return dir===1 ? r : -r;
  }
  if (!an) return dir===1 ? 1 : -1;
  if (!bn) return dir===1 ? -1 : 1;
  return dir===1 ? (ka-kb) : (kb-ka);
}
function sortNormalized(internalCol, dir){
  const idx = Array.from(normalizedRows.keys());
  idx.sort((i,j)=> compareCells(normalizedRows[i].vals[internalCol], normalizedRows[j].vals[internalCol], internalCol, dir));
  reorderByIndex(idx, normalizedRows); reorderByIndex(idx, rawRows);
  renderTable();
}
function sortRawByKey(key, dir){
  const idx = Array.from(rawRows.keys());
  idx.sort((i,j)=> compareAny(rawRows[i].data[key], rawRows[j].data[key], dir));
  reorderByIndex(idx, rawRows); reorderByIndex(idx, normalizedRows);
  renderTable();
}
function reorderByIndex(order, arr){ const cp = order.map(i=>arr[i]); arr.length=0; arr.push(...cp); }
function compareAny(a, b, dir){
  const sa = String(a ?? '').trim(); const sb = String(b ?? '').trim();
  const na = parseFloat(sa.replace(/[^\d.-]/g,'')); const nb = parseFloat(sb.replace(/[^\d.-]/g,''));
  const an = !isNaN(na); const bn = !isNaN(nb);
  if (an && bn){ return dir===1 ? (na-nb) : (nb-na) }
  const r = sa.localeCompare(sb,'zh-Hant',{numeric:true, sensitivity:'base'}); return dir===1 ? r : -r;
}

/* ================== 表頭拖曳 ================== */
function attachDragHeaders(){
  const ths = elHeadRow.querySelectorAll('th');
  let dragging = null;
  ths.forEach(th => {
    th.addEventListener('dragstart', (e)=>{ dragging = th; th.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
    th.addEventListener('dragend',   ()=>{ if (dragging) dragging.classList.remove('dragging'); dragging=null; });
    th.addEventListener('dragover', (e)=>{
      e.preventDefault();
      const target = th;
      if (!dragging || dragging===target) return;
      const rect = target.getBoundingClientRect();
      const before = (e.clientX - rect.left) < rect.width/2;
      if (before) target.parentNode.insertBefore(dragging, target);
      else target.parentNode.insertBefore(dragging, target.nextSibling);
    });
    th.addEventListener('drop', ()=>{
      if (mode==='normalized'){
        const newOrder = []; elHeadRow.querySelectorAll('th').forEach(node => newOrder.push(parseInt(node.dataset.col,10)));
        const disabled = visibleCols.filter(i=>!colEnabled[i]); visibleCols = [...newOrder, ...disabled];
      } else {
        const newOrder = []; elHeadRow.querySelectorAll('th').forEach(node => newOrder.push(node.dataset.key));
        rawSelectedHeaders = newOrder;
      }
      renderTable();
    });
  });
}

/* ================== 欄位挑選 Modal ================== */
const colModal = document.getElementById('colModal'), colList  = document.getElementById('colList');
const colApply = document.getElementById('colApply'), colCancel= document.getElementById('colCancel'), colReset = document.getElementById('colReset');
document.getElementById('btn-cols').addEventListener('click', openColPicker);
function openColPicker(){
  colList.innerHTML = '';
  const order = [...visibleCols];
  order.forEach(idx=>{
    const item = document.createElement('div'); item.className='col-item'; item.draggable = true; item.dataset.idx = String(idx);
    item.innerHTML = `<span class="drag-handle"><svg viewBox="0 0 24 24" width="14" height="14"><path d="M9 6h6M9 10h6M9 14h6M9 18h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></span>
      <input type="checkbox" ${colEnabled[idx]?'checked':''} />
      <strong>${OUTPUT_HEADERS[idx]}</strong>`;
    colList.appendChild(item);
  });
  bindColDrag(colList); showModal(colModal);
}
function bindColDrag(container){
  let dragging = null;
  container.querySelectorAll('.col-item').forEach(it=>{
    it.addEventListener('dragstart', ()=>{ dragging = it; it.classList.add('dragging') });
    it.addEventListener('dragend',   ()=>{ it.classList.remove('dragging'); dragging=null });
    it.addEventListener('dragover', (e)=>{
      e.preventDefault(); const target = it;
      if (!dragging || dragging===target) return;
      const rect = target.getBoundingClientRect(); const before = (e.clientY - rect.top) < rect.height/2;
      if (before) target.parentNode.insertBefore(dragging, target);
      else target.parentNode.insertBefore(dragging, target.nextSibling);
      target.classList.add('dragover');
    });
    it.addEventListener('dragleave', ()=> it.classList.remove('dragover'));
    it.addEventListener('drop', ()=> it.classList.remove('dragover'));
  });
}
colApply.addEventListener('click', ()=>{
  const items = Array.from(colList.querySelectorAll('.col-item'));
  const newOrder = items.map(it => parseInt(it.dataset.idx,10));
  const newEnabled = items.map(it => it.querySelector('input[type=checkbox]').checked);
  if (!newEnabled.some(Boolean)){ alert('請至少選擇 1 個欄位顯示。'); return; }
  visibleCols = newOrder; colEnabled  = newEnabled; hideModal(colModal); renderTable();
});
colCancel.addEventListener('click', ()=> hideModal(colModal));
colReset.addEventListener('click', ()=>{ visibleCols = OUTPUT_HEADERS.map((_,i)=>i); colEnabled = OUTPUT_HEADERS.map(()=>true); openColPicker(); });

/* 來源欄位 Modal */
const rawColModal = document.getElementById('rawColModal'), rawColList  = document.getElementById('rawColList');
const rawColApply = document.getElementById('rawColApply'), rawColCancel= document.getElementById('rawColCancel');
const rawColAll   = document.getElementById('rawColAll'),  rawColNone  = document.getElementById('rawColNone');
document.getElementById('btn-raw-cols').addEventListener('click', openRawColPicker);
function openRawColPicker(){
  rawColList.innerHTML = '';
  const order = rawSelectedHeaders.length ? [...rawSelectedHeaders] : [...rawUnionHeaders];
  order.forEach(h=>{
    const item = document.createElement('div'); item.className='col-item'; item.draggable = true; item.dataset.key = h;
    const label = fixEncoding(h);
    item.innerHTML = `<span class="drag-handle"><svg viewBox="0 0 24 24" width="14" height="14"><path d="M9 6h6M9 10h6M9 14h6M9 18h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg></span>
      <input type="checkbox" ${(!rawSelectedHeaders.length || rawSelectedHeaders.includes(h))?'checked':''} />
      <strong>${label}</strong>`;
    rawColList.appendChild(item);
  });
  bindColDrag(rawColList); showModal(rawColModal);
}
rawColApply.addEventListener('click', ()=>{
  const items = Array.from(rawColList.querySelectorAll('.col-item'));
  const keys  = items.map(it => it.dataset.key);
  const flags = items.map(it => it.querySelector('input[type=checkbox]').checked);
  const chosen = keys.filter((_,i)=>flags[i]);
  if (!chosen.length){ alert('請至少選擇 1 個欄位顯示。'); return; }
  rawSelectedHeaders = chosen; hideModal(rawColModal); renderTable();
});
rawColCancel.addEventListener('click', ()=> hideModal(rawColModal));
rawColAll.addEventListener('click', ()=>{ rawColList.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true); });
rawColNone.addEventListener('click', ()=>{ rawColList.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = false); });

/* ================== 分頁選擇 ================== */
function pickSheetsUI(fileName, sheetNames){
  return new Promise((resolve)=>{
    const modal = document.getElementById('sheetModal');
    const list = document.getElementById('sheetList');
    const fn = document.getElementById('sheetFileName');
    const btnAll = document.getElementById('sheetAll');
    const btnNone = document.getElementById('sheetNone');
    const btnOk = document.getElementById('sheetOk');
    const btnCancel = document.getElementById('sheetCancel');

    fn.textContent = `檔案：${fileName}`;
    list.innerHTML = '';
    sheetNames.forEach(name=>{
      const lab = document.createElement('label');
      lab.innerHTML = `<input type="checkbox" checked> <span>${escapeHtml(name)}</span>`;
      list.appendChild(lab);
    });

    const collect = ()=> Array.from(list.querySelectorAll('input[type=checkbox]'))
                          .filter(cb=>cb.checked)
                          .map((cb,i)=> sheetNames[i]);

    function close(ret){ document.removeEventListener('keydown', onKey); modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); resolve(ret); }
    function onKey(e){ if (e.key==='Escape'){ e.preventDefault(); close([]); } if (e.key==='Enter'){ e.preventDefault(); close(collect()); } }

    btnAll.onclick = ()=> list.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=true);
    btnNone.onclick= ()=> list.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=false);
    btnCancel.onclick=()=> close([]);
    btnOk.onclick    =()=> close(collect());

    modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
    document.addEventListener('keydown', onKey);
  });
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])) }
function showModal(m){ m.classList.add('show'); m.setAttribute('aria-hidden','false') }
function hideModal(m){ m.classList.remove('show'); m.setAttribute('aria-hidden','true') }

/* ================== 矩形多選 + 複製 ================== */
let selectionRanges = []; // [{r1,c1,r2,c2}]
let selecting = false;
let startCell = null;

function clearSelection(){
  selectionRanges = [];
  redrawSelection();
}
function addRange(r1,c1,r2,c2){
  const norm = normalizeRange({r1,c1,r2,c2});
  selectionRanges.push(norm);
  redrawSelection();
}
function normalizeRange({r1,c1,r2,c2}){
  const a = Math.min(r1,r2), b = Math.max(r1,r2);
  const x = Math.min(c1,c2), y = Math.max(c1,c2);
  return {r1:a, c1:x, r2:b, c2:y};
}
function redrawSelection(){
  elBtnCopy.disabled = selectionRanges.length === 0;
  elBody.querySelectorAll('td.sel').forEach(td=>td.classList.remove('sel'));
  const rows = elBody.querySelectorAll('tr');
  selectionRanges.forEach(rg=>{
    for (let r=rg.r1; r<=rg.r2; r++){
      const tr = rows[r]; if (!tr) continue;
      for (let c=rg.c1; c<=rg.c2; c++){
        const td = tr.children[c]; if (td) td.classList.add('sel');
      }
    }
  });
}
function cellPosFromEvent(e){
  const td = e.target.closest('td'); if (!td) return null;
  const tr = td.parentElement;
  const r = Array.prototype.indexOf.call(elBody.children, tr);
  const c = Array.prototype.indexOf.call(tr.children, td);
  return {r,c};
}
elBody.addEventListener('mousedown', (e)=>{
  const pos = cellPosFromEvent(e); if (!pos) return;
  selecting = true; startCell = pos;
  if (!(e.ctrlKey || e.metaKey)) clearSelection();
  const cur = normalizeRange({r1:pos.r,c1:pos.c,r2:pos.r,c2:pos.c});
  selectionRanges.push(cur);
  redrawSelection();
  e.preventDefault();
});
elBody.addEventListener('mousemove', (e)=>{
  if (!selecting || !startCell) return;
  const pos = cellPosFromEvent(e); if (!pos) return;
  const last = selectionRanges[selectionRanges.length-1];
  Object.assign(last, normalizeRange({r1:startCell.r,c1:startCell.c,r2:pos.r,c2:pos.c}));
  redrawSelection();
});
window.addEventListener('mouseup', ()=>{ selecting=false; startCell=null; });

async function copySelectedToClipboard(){
  if (!selectionRanges.length){ await copyWholeTable(); return; }
  const rows = elBody.querySelectorAll('tr');
  const blocks = selectionRanges.map(rg=>{
    const lines = [];
    for (let r=rg.r1; r<=rg.r2; r++){
      const tr = rows[r]; if (!tr) continue;
      const cells = [];
      for (let c=rg.c1; c<=rg.c2; c++){
        const td = tr.children[c];
        cells.push(td ? td.textContent : '');
      }
      lines.push(cells.join('\t'));
    }
    return lines.join('\n');
  });
  const tsv = blocks.join('\n\n');
  await writeClipboard(tsv);
}
async function copyWholeTable(){
  const rows = elBody.querySelectorAll('tr');
  const lines = Array.from(rows).map(tr => Array.from(tr.children).map(td=>td.textContent).join('\t'));
  await writeClipboard(lines.join('\n'));
}
async function writeClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    elBtnCopy.textContent = '已複製！';
    setTimeout(()=> elBtnCopy.textContent='複製所選', 1000);
  }catch(err){
    const ta = document.createElement('textarea');
    ta.style.position='fixed'; ta.style.opacity='0'; ta.value = text;
    document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); } finally { document.body.removeChild(ta); }
  }
}
elBtnCopy.addEventListener('click', copySelectedToClipboard);
document.addEventListener('keydown', (e)=>{
  const isCopy = (e.key === 'c' || e.key === 'C') && (e.ctrlKey || e.metaKey);
  if (!isCopy) return;
  if (!document.activeElement || document.activeElement === document.body) {
    e.preventDefault(); copySelectedToClipboard();
  }
});

/* ================== 初始化 ================== */
renderTable();
</script>
</body>
</html>
